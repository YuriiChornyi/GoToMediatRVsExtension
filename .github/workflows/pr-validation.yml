name: PR Validation

on:
  pull_request:
    branches: [ main ]
    types: [opened, synchronize, reopened]

jobs:
  validate-pr:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      with:
        nuget-version: 'latest'

    - name: Restore NuGet packages
      run: nuget restore VSIXExtention.sln

    - name: Build solution
      run: msbuild VSIXExtention.sln /p:Configuration=Debug /p:Platform="Any CPU" /p:DeployExtension=false /v:minimal

    - name: Check version was bumped
      shell: powershell
      run: |
        [xml]$manifest = Get-Content "source.extension.vsixmanifest"
        $prVersion = $manifest.PackageManifest.Metadata.Identity.Version
        Write-Host "Version in this PR: $prVersion"

        $latestTag = git tag --list "v*" --sort=-version:refname | Select-Object -First 1
        if (-not $latestTag) {
            Write-Host "No existing release tags found, version check skipped."
            exit 0
        }

        $tagVersion = $latestTag.TrimStart("v")
        Write-Host "Latest released version (from tag): $tagVersion"

        if ($prVersion -eq $tagVersion) {
            Write-Error "Version $prVersion in source.extension.vsixmanifest has not been bumped. Please update the version before merging."
            exit 1
        }

        Write-Host "Version bump confirmed: $tagVersion to $prVersion"
