name: Release on Push to Main

on:
  push:
    branches: [ main ]

jobs:
  release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      with:
        nuget-version: 'latest'

    - name: Restore NuGet packages
      run: nuget restore VSIXExtention.sln

    - name: Build solution
      shell: powershell
      run: |
        msbuild VSIXExtention.sln /p:Configuration=Release /p:Platform="Any CPU" /p:DeployExtension=false /p:ZipPackageCompressionLevel=normal /v:minimal

        $vsixFile = Get-ChildItem -Path "." -Filter "*.vsix" -Recurse |
            Where-Object { $_.Directory.Name -eq "Release" } |
            Select-Object -First 1

        if (-not $vsixFile) {
            Write-Error "VSIX file not found after build!"
            exit 1
        }

        echo "VSIX_PATH=$($vsixFile.FullName)" >> $env:GITHUB_ENV
        echo "VSIX_NAME=$($vsixFile.Name)" >> $env:GITHUB_ENV
        Write-Host "VSIX ready: $($vsixFile.FullName)"

    - name: Read version from manifest
      id: version
      shell: powershell
      run: |
        [xml]$manifest = Get-Content "source.extension.vsixmanifest"
        $version = $manifest.PackageManifest.Metadata.Identity.Version
        echo "value=$version" >> $env:GITHUB_OUTPUT
        Write-Host "Version: $version"

    - name: Collect commit messages since last release
      id: notes
      shell: powershell
      run: |
        $latestTag = git tag --list "v*" --sort=-version:refname | Select-Object -First 1

        if ($latestTag) {
            Write-Host "Collecting commits since tag: $latestTag"
            $commits = git log "$latestTag..HEAD" --pretty=format:"- %s" --no-merges
        } else {
            Write-Host "No previous tags found â€” using all commits"
            $commits = git log --pretty=format:"- %s" --no-merges
        }

        if (-not $commits) {
            $commits = "- Initial release"
        }

        # Write to file to avoid multiline env var issues
        $commits | Out-File -FilePath "release-notes.md" -Encoding UTF8
        Write-Host "Release notes:`n$commits"

    - name: Create GitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: v${{ steps.version.outputs.value }}
        name: MediatR Navigation Extension v${{ steps.version.outputs.value }}
        body_path: release-notes.md
        draft: false
        prerelease: false
        files: ${{ env.VSIX_PATH }}
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: Clean up
      if: always()
      shell: powershell
      run: Remove-Item "release-notes.md" -ErrorAction SilentlyContinue
