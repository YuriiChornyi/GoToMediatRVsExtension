name: Release on Push to Main

on:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  release:
    runs-on: windows-latest

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        fetch-depth: 0

    - name: Setup MSBuild
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64

    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      with:
        nuget-version: 'latest'

    - name: Restore NuGet packages
      run: nuget restore VSIXExtention.sln

    - name: Build solution
      shell: powershell
      run: |
        msbuild VSIXExtention.sln /p:Configuration=Release /p:Platform="Any CPU" /p:DeployExtension=false /p:ZipPackageCompressionLevel=normal /v:minimal

        $vsixFile = Get-ChildItem -Path "." -Filter "*.vsix" -Recurse |
            Where-Object { $_.Directory.Name -eq "Release" } |
            Select-Object -First 1

        if (-not $vsixFile) {
            Write-Error "VSIX file not found after build!"
            exit 1
        }

        echo "VSIX_PATH=$($vsixFile.FullName)" >> $env:GITHUB_ENV
        echo "VSIX_NAME=$($vsixFile.Name)" >> $env:GITHUB_ENV
        Write-Host "VSIX ready: $($vsixFile.FullName)"

    - name: Read version from manifest
      id: version
      shell: powershell
      run: |
        [xml]$manifest = Get-Content "source.extension.vsixmanifest"
        $version = $manifest.PackageManifest.Metadata.Identity.Version
        echo "value=$version" >> $env:GITHUB_OUTPUT
        Write-Host "Version: $version"

    - name: Collect commit messages since last release
      id: notes
      shell: powershell
      run: |
        $latestTag = git tag --list "v*" --sort=-version:refname | Select-Object -First 1

        if ($latestTag) {
            Write-Host "Collecting commits since tag: $latestTag"
            $allCommits = git log "$latestTag..HEAD" --pretty=format:"- %s" --no-merges
        } else {
            Write-Host "No previous tags found, using all commits"
            $allCommits = git log --pretty=format:"- %s" --no-merges
        }

        $commits = $allCommits | Where-Object { $_ -notmatch "^- Merge pull request" }

        if (-not $commits) {
            $commits = "- Initial release"
        }

        $commits | Out-File -FilePath "release-notes.md" -Encoding UTF8
        Write-Host "Release notes:"
        Write-Host $commits

    - name: Create git tag
      shell: powershell
      run: |
        $tag = "v${{ steps.version.outputs.value }}"
        git tag $tag
        git push origin $tag
        Write-Host "Tag created and pushed: $tag"

    - name: Create GitHub Release
      shell: powershell
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $tag = "v${{ steps.version.outputs.value }}"
        $name = "MediatR Navigation Extension $tag"
        $vsix = $env:VSIX_PATH

        gh release create $tag $vsix --title $name --notes-file release-notes.md

    - name: Clean up
      if: always()
      shell: powershell
      run: Remove-Item "release-notes.md" -ErrorAction SilentlyContinue
