name: Publish to Visual Studio Marketplace

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish (e.g., v1.0.0)'
        required: true
        type: string

jobs:
  publish-to-marketplace:
    runs-on: windows-latest
    environment: production
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.release_tag || github.ref }}
    
    - name: Setup .NET Framework
      uses: microsoft/setup-msbuild@v2
      with:
        msbuild-architecture: x64
    
    - name: Setup NuGet
      uses: NuGet/setup-nuget@v2
      with:
        nuget-version: 'latest'
    
    - name: Restore NuGet packages
      run: nuget restore VSIXExtention.sln
    
    - name: Build for marketplace
      shell: powershell
      run: |
        Write-Host "Building for marketplace publication..."
        msbuild VSIXExtention.sln /p:Configuration=Release /p:Platform="Any CPU" /p:DeployExtension=false /p:ZipPackageCompressionLevel=normal /v:minimal
        
        # Find the generated VSIX file
        $vsixFile = Get-ChildItem -Path "bin\Release" -Filter "*.vsix" -Recurse | Select-Object -First 1
        if ($vsixFile) {
            echo "VSIX_PATH=$($vsixFile.FullName)" >> $env:GITHUB_ENV
            Write-Host "VSIX file ready: $($vsixFile.FullName)"
        } else {
            Write-Error "VSIX file not found!"
            exit 1
        }
    
    - name: Prepare for marketplace publication
      shell: powershell
      run: |
        Write-Host "Preparing for Visual Studio Marketplace publication..."
        Write-Host "Using direct REST API approach - no CLI tool installation needed"
    
    - name: Publish to Visual Studio Marketplace
      shell: powershell
      env:
        MARKETPLACE_PAT: ${{ secrets.MARKETPLACE_PAT }}
      run: |
        Write-Host "Publishing to Visual Studio Marketplace..."
        
        if (-not $env:MARKETPLACE_PAT) {
            Write-Error "MARKETPLACE_PAT secret is not set!"
            exit 1
        }
        
        # Get version from manifest
        [xml]$manifest = Get-Content "source.extension.vsixmanifest"
        $version = $manifest.PackageManifest.Metadata.Identity.Version
        $displayName = $manifest.PackageManifest.Metadata.DisplayName
        
        Write-Host "Publishing $displayName version $version"
        Write-Host "VSIX Path: $env:VSIX_PATH"
        
        try {
            # Using the Visual Studio Marketplace REST API
            # The API requires multipart/form-data format for VSIX uploads
            
            # Create boundary for multipart form data
            $boundary = [System.Guid]::NewGuid().ToString()
            $LF = "`r`n"
            
            # Read VSIX file content
            $vsixBytes = [System.IO.File]::ReadAllBytes($env:VSIX_PATH)
            $vsixFileName = [System.IO.Path]::GetFileName($env:VSIX_PATH)
            
            # Create multipart form data body
            $bodyStart = "--$boundary$LF" +
                         "Content-Disposition: form-data; name=`"upload`"; filename=`"$vsixFileName`"$LF" +
                         "Content-Type: application/octet-stream$LF$LF"
            $bodyEnd = "$LF--$boundary--$LF"
            
            # Convert strings to bytes
            $bodyStartBytes = [System.Text.Encoding]::UTF8.GetBytes($bodyStart)
            $bodyEndBytes = [System.Text.Encoding]::UTF8.GetBytes($bodyEnd)
            
            # Combine all bytes
            $bodyBytes = $bodyStartBytes + $vsixBytes + $bodyEndBytes
            
            # Prepare headers
            $headers = @{
                'Authorization' = "Basic $([Convert]::ToBase64String([Text.Encoding]::ASCII.GetBytes(":$env:MARKETPLACE_PAT")))"
                'Content-Type' = "multipart/form-data; boundary=$boundary"
                'Accept' = 'application/json'
            }
            
            $publishUrl = "https://marketplace.visualstudio.com/_apis/gallery/extensions?api-version=7.1-preview.1"
            
            Write-Host "Uploading VSIX to marketplace using multipart form data..."
            Write-Host "File size: $($vsixBytes.Length) bytes"
            Write-Host "API URL: $publishUrl"
            
            $response = Invoke-RestMethod -Uri $publishUrl -Method Post -Body $bodyBytes -Headers $headers
            
            Write-Host "Successfully published to Visual Studio Marketplace!"
            Write-Host "Extension ID: $($response.extensionId)"
            Write-Host "Publisher: $($response.publisher.publisherName)"
            Write-Host "Version: $($response.versions[0].version)"
            
        } catch {
            Write-Error "Failed to publish to marketplace: $($_.Exception.Message)"
            
            # Try to get more detailed error information
            if ($_.Exception.Response) {
                $reader = New-Object System.IO.StreamReader($_.Exception.Response.GetResponseStream())
                $responseBody = $reader.ReadToEnd()
                $reader.Close()
                Write-Host "Response Status: $($_.Exception.Response.StatusCode)"
                Write-Host "Response Body: $responseBody"
            }
            
            # Additional debugging information
            Write-Host "Request URL: $publishUrl"
            Write-Host "VSIX file exists: $(Test-Path $env:VSIX_PATH)"
            Write-Host "VSIX file size: $((Get-Item $env:VSIX_PATH).Length) bytes"
            
            exit 1
        }
    
    - name: Update marketplace listing (optional)
      if: success()
      shell: powershell
      env:
        MARKETPLACE_PAT: ${{ secrets.MARKETPLACE_PAT }}
      run: |
        Write-Host "Marketplace publication completed successfully!"
        
        # You can add additional steps here to:
        # - Update the marketplace description
        # - Add release notes
        # - Update screenshots
        # - etc.
