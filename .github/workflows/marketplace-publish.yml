name: Publish to VS Marketplace

on:
  release:
    types: [published]
  workflow_dispatch:
    inputs:
      release_tag:
        description: 'Release tag to publish (e.g., v6.5)'
        required: true
        type: string

permissions:
  contents: read

jobs:
  publish:
    runs-on: windows-latest
    environment: production

    steps:
    - name: Checkout code
      uses: actions/checkout@v4
      with:
        ref: ${{ inputs.release_tag || github.ref }}

    - name: Download VSIX from release
      shell: powershell
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        $tag = "${{ inputs.release_tag || github.event.release.tag_name }}"
        if (-not $tag) {
            Write-Error "No release tag resolved. Check trigger context."
            exit 1
        }
        Write-Host "Downloading VSIX from release: $tag"

        gh release download $tag --pattern "*.vsix" --dir .

        $vsixFile = Get-ChildItem -Path "." -Filter "*.vsix" | Select-Object -First 1
        if (-not $vsixFile) {
            Write-Error "No VSIX file found in release $tag"
            exit 1
        }

        echo "VSIX_PATH=$($vsixFile.FullName)" >> $env:GITHUB_ENV
        Write-Host "Downloaded: $($vsixFile.Name) ($($vsixFile.Length) bytes)"

    - name: Locate VsixPublisher.exe
      shell: powershell
      run: |
        $vsWherePath = "${env:ProgramFiles(x86)}\Microsoft Visual Studio\Installer\vswhere.exe"
        if (-not (Test-Path $vsWherePath)) {
            Write-Error "vswhere.exe not found"
            exit 1
        }

        $vsInstallPath = & $vsWherePath -latest -products * -requires Microsoft.VisualStudio.Component.VSSDK -property installationPath
        if (-not $vsInstallPath) {
            $vsInstallPath = & $vsWherePath -latest -products * -property installationPath
        }
        if (-not $vsInstallPath) {
            Write-Error "No Visual Studio installation found"
            exit 1
        }

        $publisherExe = Get-ChildItem -Path $vsInstallPath -Filter "VsixPublisher.exe" -Recurse -ErrorAction SilentlyContinue | Select-Object -First 1
        if (-not $publisherExe) {
            Write-Error "VsixPublisher.exe not found in $vsInstallPath"
            exit 1
        }

        echo "VSIX_PUBLISHER=$($publisherExe.FullName)" >> $env:GITHUB_ENV
        Write-Host "Found VsixPublisher.exe: $($publisherExe.FullName)"

    - name: Publish to marketplace
      shell: powershell
      env:
        MARKETPLACE_PAT: ${{ secrets.MARKETPLACE_PAT }}
      run: |
        if (-not $env:MARKETPLACE_PAT) {
            Write-Error "MARKETPLACE_PAT secret is not set!"
            exit 1
        }

        if (-not (Test-Path "publishManifest.json")) {
            Write-Error "publishManifest.json not found in repo root"
            exit 1
        }

        [xml]$manifest = Get-Content "source.extension.vsixmanifest"
        $version = $manifest.PackageManifest.Metadata.Identity.Version
        Write-Host "Publishing version $version to Visual Studio Marketplace..."

        & $env:VSIX_PUBLISHER publish -payload "$env:VSIX_PATH" -publishManifest "publishManifest.json" -personalAccessToken $env:MARKETPLACE_PAT -ignoreWarnings "VSIXValidatorWarning01,VSIXValidatorWarning02"

        if ($LASTEXITCODE -ne 0) {
            Write-Error "VsixPublisher.exe failed with exit code $LASTEXITCODE"
            exit 1
        }

        Write-Host "Successfully published version $version to the marketplace."
